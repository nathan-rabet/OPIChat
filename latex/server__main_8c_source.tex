\hypertarget{server__main_8c_source}{}\doxysection{server\+\_\+main.\+c}
\label{server__main_8c_source}\index{src/server\_main.c@{src/server\_main.c}}
\mbox{\hyperlink{server__main_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00001}00001 \textcolor{preprocessor}{\#include <errno.h>}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00002}00002 \textcolor{preprocessor}{\#include <stdbool.h>}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00003}00003 \textcolor{preprocessor}{\#include <stdio.h>}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00004}00004 \textcolor{preprocessor}{\#include <stdlib.h>}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00005}00005 \textcolor{preprocessor}{\#include <sys/epoll.h>}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00006}00006 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00007}00007 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{client_8h}{client.h}}"{}}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00008}00008 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{epoll__handler_8h}{epoll\_handler.h}}"{}}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00009}00009 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{init__socket_8h}{init\_socket.h}}"{}}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00010}00010 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{logger_8h}{logger.h}}"{}}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00011}00011 \textcolor{preprocessor}{\#include "{}xalloc.h"{}}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00012}00012 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00013}00013 \textcolor{keyword}{extern} \textcolor{keywordtype}{int} \mbox{\hyperlink{server__main_8c_a563c714502d84960831913304caca7f3}{epoll\_instance}};}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00014}00014 \textcolor{keyword}{extern} \textcolor{keyword}{struct }\mbox{\hyperlink{structclient}{client}} *\mbox{\hyperlink{server__main_8c_ab13b91cda85acbe50143a8d0cbec99f8}{clients}};}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00015}00015 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00016}\mbox{\hyperlink{server__main_8c_a0ddf1224851353fc92bfbff6f499fa97}{00016}} \textcolor{keywordtype}{int} \mbox{\hyperlink{server__main_8c_a0ddf1224851353fc92bfbff6f499fa97}{main}}(\textcolor{keywordtype}{int} argc, \textcolor{keywordtype}{char} *argv[])}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00017}00017 \{}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00018}00018     \textcolor{keywordflow}{if} (argc != 3)}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00019}00019     \{}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00020}00020         fprintf(stderr, \textcolor{stringliteral}{"{}usage: \%s <ip> <port>\(\backslash\)n"{}}, argv[0]);}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00021}00021         exit(EXIT\_FAILURE);}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00022}00022     \}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00023}00023 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00024}00024     \mbox{\hyperlink{logger_8h_adbd31571b49f4ff32cda46460abe6469}{logger\_init}}(\textcolor{stringliteral}{"{}server.log"{}});}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00025}00025 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00026}00026     \textcolor{keywordtype}{int} \mbox{\hyperlink{init__socket_8h_a9329c4790c307301a22f6d23cdc23edd}{server\_socket}} = \mbox{\hyperlink{init__socket_8h_a52a29341829d13d3e6bd26bfb9cd8939}{setup\_server\_socket}}(argv[1], argv[2]);}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00027}00027 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00028}00028     \mbox{\hyperlink{server__main_8c_a563c714502d84960831913304caca7f3}{epoll\_instance}} = epoll\_create1(0);}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00029}00029     \textcolor{keywordflow}{if} (\mbox{\hyperlink{server__main_8c_a563c714502d84960831913304caca7f3}{epoll\_instance}} == -\/1)}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00030}00030         \mbox{\hyperlink{logger_8h_aa3c3e5e89264af119696a729635581e4}{raise\_panic}}(EXIT\_FAILURE, \textcolor{stringliteral}{"{}Impossible to create epoll instance"{}});}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00031}00031 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00032}00032     \textcolor{keyword}{struct }epoll\_event event;}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00033}00033     \textcolor{keyword}{event}.events = EPOLLIN;}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00034}00034     \textcolor{keyword}{event}.data.fd = \mbox{\hyperlink{init__socket_8h_a9329c4790c307301a22f6d23cdc23edd}{server\_socket}};}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00035}00035 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00036}00036     \textcolor{keywordflow}{if} (epoll\_ctl(\mbox{\hyperlink{server__main_8c_a563c714502d84960831913304caca7f3}{epoll\_instance}}, EPOLL\_CTL\_ADD, \mbox{\hyperlink{init__socket_8h_a9329c4790c307301a22f6d23cdc23edd}{server\_socket}}, \&event) == -\/1)}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00037}00037         \mbox{\hyperlink{logger_8h_aa3c3e5e89264af119696a729635581e4}{raise\_panic}}(EXIT\_FAILURE,}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00038}00038                     \textcolor{stringliteral}{"{}Impossible to add server socket to epoll instance : \%s"{}},}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00039}00039                     hstrerror(errno));}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00040}00040 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00041}00041     \textcolor{keyword}{struct }epoll\_event events[\mbox{\hyperlink{epoll-server_8h_ae42954bb8545d24e3e9dcde5920c9a0b}{MAX\_EVENTS}}] = \{ 0 \};}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00042}00042 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00043}00043     \textcolor{keywordflow}{while} (\textcolor{keyword}{true})}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00044}00044     \{}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00045}00045         \textcolor{keywordtype}{int} nb\_events = epoll\_wait(\mbox{\hyperlink{server__main_8c_a563c714502d84960831913304caca7f3}{epoll\_instance}}, events, 1, -\/1);}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00046}00046         \textcolor{keywordflow}{if} (nb\_events == -\/1)}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00047}00047             \mbox{\hyperlink{logger_8h_aa2f6842f436362eed5f832d3b6611165}{write\_error}}(\textcolor{stringliteral}{"{}Impossible to wait for events : \%s"{}}, hstrerror(errno));}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00048}00048 }
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00049}00049         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < nb\_events; i++)}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00050}00050         \{}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00051}00051             \textcolor{keywordflow}{if} (events[i].data.fd == \mbox{\hyperlink{init__socket_8h_a9329c4790c307301a22f6d23cdc23edd}{server\_socket}})}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00052}00052                 \mbox{\hyperlink{basic__server_8c_ace3f10a600415838e09a4302024a5c30}{accept\_client}}(\mbox{\hyperlink{init__socket_8h_a9329c4790c307301a22f6d23cdc23edd}{server\_socket}});}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00053}00053             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00054}00054                 \mbox{\hyperlink{basic__client_8c_a7cea10a6474f60869a6370bbb7836e4e}{communicate}}(events[i].data.fd);}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00055}00055         \}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00056}00056     \}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00057}00057     \textcolor{keywordflow}{return} 0;}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00058}00058     \textcolor{comment}{/* NOTE : The global struct client is handled inside the}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00059}00059 \textcolor{comment}{    `accept\_client` \& `communicate functions */}}
\DoxyCodeLine{\Hypertarget{server__main_8c_source_l00060}00060 \}}

\end{DoxyCode}
